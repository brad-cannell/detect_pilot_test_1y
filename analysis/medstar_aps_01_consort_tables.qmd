---
title: "Consort Tables"
format: html
#editor: visual
---

# Summary

-   There were 16,565 Subjects in the MedStar data set

    -   1,967 Subjects were also present in the APS data set

    -   492 Responses had a paired intake from the APS data set, representing 461 APS Case Numbers

-   Data was taken from the Response-Intake row-paired data

    -   28,228 Responses represented an individual eligible for DETECT screening

    -   24,007 Responses included at least one DETECT item

        -   336 of these had a positive screening

            -   278 of these had a matching APS Intake, and 58 did not

            -   229 of those with a paired APS Intake were associated with a case with at least one valid allegation, and 49 were not

        -   23,649 had a negative screening

            -   186 of these had a matching APS Intake, and 23,463 did not

            -   141 of those with a paired APS Intake were associated with a case with at least one valid allegation, and 45 were not

        -   22 were missing a value regarding the determination

            -   Of these, none had a matching APS Intake

    -   4,221 Responses included no DETECT items

        -   28 of these had a matched APS Intake, and 4,193 did not

        -   24 of those with a paired APS Intake were associated with a case with at least one valid allegation, and 4 were not

# Imports

## Library Imports

```{r}
#| message: false
#| warning: false

library(tidyverse)
library(here)
library(lubridate)
```

## Data Imports

We imported the MedStar data set that included paired APS Intakes for processing.

```{r}
ms_paired <- readRDS(here("data","DETECT Shared GRAs","merge_aps_medstar",
                "medstar_aps_merged_02_response_based_row_pairs.rds"))
```

We imported the data set which included a summary for each Subject present in both data sets.

```{r}
subj_data <- readRDS(here("data","DETECT Shared GRAs","merge_aps_medstar",
                         "medstar_aps_merged_03_single_subject_per_row.rds"))
```

## Functions

### Unique Value Summary

A function written in a previous cleaning document was imported. It was written to display counts of each unique observations within a selection of columns.

```{r}
get_unique_value_summary <- function(df,cols){
  
  # Input: 
  #     df (data frame) - original source data frame
  #     cols (list) - list of target column names as strings
  # Output:
  #     unique_summary (data frame) - summary counts of each unique value in
  #           each of the target columns
  
  # Get list of unique values in all target columns
  
  val <- unique(as.factor(as.vector(as.matrix(df[cols]))))
  
  # Initialize output data frame with unique value row
  
  unique_summary <- data.frame("value"=val)
  
  # Get counts of unique values in original data frame
  
  for (i in cols){
    
    # utilizes table to get summary count of each column
    
    table <- as.data.frame(table(df[i]))
    
    # sets column names to "value" and "freq"
    
  colnames(table) <- c("value","freq")
  
    # adds count of missing values in each column
  
  table<- add_row(table, value = NA, freq = sum(is.na(df[i])))
  
    # readjusts names of columns to "value" and the name of the target column
  
  colnames(table) <- c("value",i)
  
    # joins table's summary counts to complete the count values
  
    unique_summary <- left_join(unique_summary,table, by="value")
  }
  
  # returns completed, but unordered, data frame
  
  unique_summary
  }
```

# Individual Intakes

# Overview

There were a total of 28,228 MedStar Responses in our data set. This represented 16,565 Subjects, 1,967 of which were also represented in the APS data set. There were 492 Responses with a paired APS Intake, which represented 461 APS Case Numbers.

```{r}
nrow(ms_paired)
length(unique(ms_paired$id))

temp_df <- ms_paired %>%
  filter(!is.na(aps_person_id))

length(unique(temp_df$aps_person_id))

temp_df <- temp_df %>%
  filter(!is.na(aps_row))

nrow(temp_df)
length(unique(temp_df$aps_case_num))
```

## Screen vs No Screen

We isolated our DETECT Questionnaire variables into two groups: the variables relating to comments entered into the "Report Number" field that were not strictly a report number, and the DETECT Tool questions.

```{r}
detect_comment_vars <- ms_paired %>%
  select(detect_report_comment, detect_report_aps_unable, 
         detect_report_aps_onscene, detect_report_aps_existing, 
         detect_facility, detect_other_reporter, detect_uta
         ) %>%
  names()

detect_questions <- ms_paired %>%
  select(starts_with("detect_")
         ) %>%
  select(-all_of(c(detect_comment_vars))
         ) %>%
  names()
```

There were 4,221 Observations without a single DETECT Tool variable entered. This included 2,769 Subjects. There were 28 paired APS Intakes for these observations, representing 27 APS Case Numbers.

```{r}
ms_paired$na_count <- rowSums (is.na(ms_paired[,detect_questions]))

no_screen <- ms_paired %>%
  filter(na_count == length(detect_questions))

nrow(no_screen)

length(unique(no_screen$id))
length(unique(no_screen$aps_row))
length(unique(no_screen$aps_case_num))
```

There were 24,007 Observations with at least one DETECT Tool variable entered. This included 15,212 Subjects. There were 464 paired APS Intakes for these observations, representing 437 APS Case Numbers.

```{r}
screened <- ms_paired %>%
  filter(na_count < length(detect_questions))

nrow(screened)

length(unique(screened$id))
length(unique(screened$aps_row))
length(unique(screened$aps_case_num))
```

Of the 24,007 Responses with at least one DETECT question completed, 336 indicated a positive screening, 23,649 indicated a negative screening, and 22 did not indicate either a positive or negative screening (missing value).

```{r}
get_unique_value_summary(screened, 'detect_report_made')
```

## Matching to APS

### Screened Positive

The 336 Responses which had a positive screening represented 300 Subjects.

```{r}
checking <- screened %>%
  filter(detect_report_made == "YES")

nrow(checking)
length(unique(checking$id))
```

There were 278 of these Responses with a paired APS Intake, representing 267 APS Cases across 278 Subjects. There were 58 Responses without a paired APS Intake.

```{r}
checking_subset <- checking %>%
  filter(!is.na(aps_row))

nrow(checking_subset)
nrow(checking) - nrow(checking_subset)
length(unique(checking_subset$id))
length(unique(checking_subset$aps_row))
length(unique(checking_subset$aps_case_num))
```

Of these, 229 were associated with an APS Case Number that had at least one valid allegation, 49 which did not have any valid allegations.

```{r}
get_unique_value_summary(checking_subset, 'aps_cases_any_valid')
```

### Screened Negative

The 23,649 Responses which had a negative screening represented 15,091 Subjects.

```{r}
checking <- screened %>%
  filter(detect_report_made == "NO")

nrow(checking)
length(unique(checking$id))
```

There were 186 of these Responses with a paired APS Intake, representing 178 APS Cases across 172 Subjects. There were 23,463 Responses without a paired APS Intake.

```{r}
checking_subset <- checking %>%
  filter(!is.na(aps_row))

nrow(checking_subset)
nrow(checking) - nrow(checking_subset)
length(unique(checking_subset$id))
length(unique(checking_subset$aps_row))
length(unique(checking_subset$aps_case_num))
```

Of these, 141 were associated with an APS Case Number that had at least one valid allegation, 45 which did not have any valid allegations.

```{r}
get_unique_value_summary(checking_subset, 'aps_cases_any_valid')
```

### Missing Screening Determination

The 22 Responses which had a missing value regarding the screening determination represented 22 Subjects.

```{r}
checking <- screened %>%
  filter(is.na(detect_report_made))

nrow(checking)
length(unique(checking$id))
```

None of these Intakes had a matched row in the APS data set.

```{r}
checking_subset <- checking %>%
  filter(!is.na(aps_row))

nrow(checking_subset)
nrow(checking) - nrow(checking_subset)
length(unique(checking_subset$id))
length(unique(checking_subset$aps_row))
length(unique(checking_subset$aps_case_num))
```

### Not Screened

The 4,221 Responses which were not screened represented 2,769 Subjects.

```{r}
checking <- no_screen  

nrow(checking)
length(unique(checking$id))
```

There were 28 of these Responses with a paired APS Intake, representing 27 APS Cases across 27 Subjects. There were 4,193 Responses without a paired APS Intake.

```{r}
checking_subset <- checking %>%
  filter(!is.na(aps_row))

nrow(checking_subset)
nrow(checking) - nrow(checking_subset)
length(unique(checking_subset$id))
length(unique(checking_subset$aps_row))
length(unique(checking_subset$aps_case_num))
```

Of these, 24 were associated with an APS Case Number that had at least one valid allegation, 4 which did not have any valid allegations.

```{r}
get_unique_value_summary(checking_subset, 'aps_cases_any_valid')
```

# Subject-Wide Aggregate

## Overview

There were a total of 16,565 Subjects in our subject-wise data set, 1,967 of which were also represented in the APS data set. These Subjects represented a total of 28,228 MedStar Responses, 4,188 APS Intakes, and 3,399 APS Case Numbers.

```{r}
nrow(subj_data)
length(unique(subj_data$id))
sum(subj_data$ms_subj_num_responses)

temp_df <- subj_data %>%
  filter(!is.na(aps_person_id))

length(unique(temp_df$aps_person_id))

sum(subj_data$aps_subject_num_intakes, na.rm=TRUE)
sum(subj_data$aps_subject_num_cases, na.rm=TRUE)
```

## Screen vs No Screen

There were 15,212 subjects which had at least one DETECT tool variable selected. These subjects represented 26,622 MedStar responses, and 24,007 DETECT screenings. Of these, 1,860 subjects were also present in the APS data set, representing 4,005 APS Intakes and 3,242 APS Case Numbers.

```{r}
screened <- subj_data %>%
  filter(ms_subj_screen_count > 0)

nrow(screened)
sum(screened$ms_subj_num_responses)
sum(screened$ms_subj_screen_count)

length(unique(screened[!is.na(screened$aps_person_id),]$aps_person_id))
sum(screened$aps_subject_num_intakes, na.rm = TRUE)
sum(screened$aps_subject_num_cases, na.rm = TRUE)
```

There were 1,353 subjects which were never screened with the DETECT tool. These subjects represented 1,606 MedStar responses. Of these, 107 subjects were also present in the APS data set, representing 183 APS Intakes and 157 APS Case Numbers.

```{r}
no_screen <- subj_data %>%
  filter(ms_subj_screen_count == 0)

nrow(no_screen)
sum(no_screen$ms_subj_num_responses)
sum(no_screen$ms_subj_screen_count)

length(unique(no_screen[!is.na(no_screen$aps_person_id),]$aps_person_id))
sum(no_screen$aps_subject_num_intakes, na.rm = TRUE)
sum(no_screen$aps_subject_num_cases, na.rm = TRUE)
```

## Matching to APS

### Screened Positive

The 300 Subjects which had at least one positive screening represented 1,121 MedStar Responses and 944 DETECT screenings. Of these, 269 were also present in the APS data set, representing 827 APS Intakes and 579 APS Case Numbers.

```{r}
checking <- screened %>%
  filter(detect_report_made > 0)

nrow(checking)
sum(checking$ms_subj_num_responses)
sum(checking$ms_subj_screen_count)

length(unique(checking[!is.na(checking$aps_person_id),]$aps_person_id))
sum(checking$aps_subject_num_intakes, na.rm = TRUE)
sum(checking$aps_subject_num_cases, na.rm = TRUE)
```

Of the 300 Subjects which had at least one positive screening, 241 were associated with at least one valid determination of elder mistreatment in the APS data set, and 28 were not. The remaining 31 Subjects were not present in the APS data set.

```{r}
get_unique_value_summary(checking, 'aps_subject_any_valid')
```

### Screened Positive

The 14,912 Subjects which had no positive screening represented 25,501 MedStar Responses and 23,063 DETECT screenings. Of these, 1,591 were also present in the APS data set, representing 3178 APS Intakes and 2,663 APS Case Numbers.

```{r}
checking <- screened %>%
  filter(detect_report_made == 0)

nrow(checking)
sum(checking$ms_subj_num_responses)
sum(checking$ms_subj_screen_count)

length(unique(checking[!is.na(checking$aps_person_id),]$aps_person_id))
sum(checking$aps_subject_num_intakes, na.rm = TRUE)
sum(checking$aps_subject_num_cases, na.rm = TRUE)
```

Of the 14,912 Subjects which had no positive screening, 1,022 were associated with at least one valid determination of elder mistreatment in the APS data set, and 569 were not. The remaining 13,321 Subjects were not present in the APS data set.

```{r}
get_unique_value_summary(checking, 'aps_subject_any_valid')
```

### Not Screened

Of the 1,353 Subjects which were not screened with the DETECT tool, 68 were associated with at least one valid determination of elder mistreatment in the APS data set, and 39 were not. The remaining 1,246 Subjects were not present in the APS data set.


```{r}
get_unique_value_summary(no_screen, 'aps_subject_any_valid')
```

# BOTTOM